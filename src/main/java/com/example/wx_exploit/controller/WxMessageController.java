package com.example.wx_exploit.controller;

import com.example.wx_exploit.util.weixinSignUtil;
import lombok.extern.slf4j.Slf4j;
import me.chanjar.weixin.mp.api.WxMpService;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.web.ServerProperties;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Map;

/**
 * @author 李皓
 * @version 1.0.0
 * @ClassName WxMessageController.java
 * @Description TODO
 * @createTime 2021年08月10日 10:31:00
 */
@RestController
@Slf4j
@RequestMapping("/wx")
public class WxMessageController extends HttpServlet {
/*
    @Autowired
    private WxMpService wxMpService;*/

/*    @Autowired
    private weixinSignUtil weixinSignUtil;*/
    weixinSignUtil weixinSignUtil = new weixinSignUtil();

    @RequestMapping("/getMessage")
    public void getMessage(HttpServletRequest request, HttpServletResponse response){
        try {
            request.setCharacterEncoding("UTF-8");
            response.setCharacterEncoding("UTF-8");
            response.setContentType("text/html;charset=utf-8");

            log.info("校验微信服务器发送信息");
            // 签名
            String signature = request.getParameter("signature");
            // 时间戳
            String timestamp = request.getParameter("timestamp");
            // 随机数
            String nonce = request.getParameter("nonce");

                if (weixinSignUtil.checkSignature(signature,timestamp,nonce)){
                    // 随机字符串
                    String echostr = request.getParameter("echostr");
                    log.info("接入成功，echostr:{}", echostr);
                    if(StringUtils.isNotBlank(echostr)){
                        response.getWriter().write(echostr);
                        return;
                    }
                }else{
                    log.info("验证失败，timestamp:{},signature:{},nonce:{}", new Object[]{timestamp,signature,nonce});
                    response.getWriter().write("微信服务器验证失败");
                    return;
                }

            //接收消息
            Map<String, String> stringMap = weixinSignUtil.parseRequest(request.getInputStream());
            String respose = weixinSignUtil.getRespose(stringMap);
            response.getWriter().write(respose);
        }catch (Exception e){
            e.printStackTrace();
        }
    }

    @RequestMapping("/returnMessages")
    public void returnMessages(HttpServletRequest request, HttpServletResponse response){
        try {
            Map<String, String> stringMap = weixinSignUtil.parseRequest(request.getInputStream());
            weixinSignUtil.ReturnMessages(stringMap);
        } catch (IOException e) {
            e.printStackTrace();
        }

    }


}
